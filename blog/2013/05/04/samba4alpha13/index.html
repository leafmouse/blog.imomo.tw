
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Samba4 alpha13 實作筆記 - Jim's Blog</title>
  <meta name="author" content="Jim Chen">

  
  <meta name="description" content="系統環境:
CentOS 5.5 所需套件:
Samba： 4 alpha13 一、 Download Samba 4 以下二種做法請擇一使用 rsync -avz samba.org::ftp/unpacked/samba_4_0_test/ samba4
git clone git://git &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://leafmouse.github.io/blog/blog/2013/05/04/samba4alpha13">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Jim's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Jim's Blog</a></h1>
  
    <h2>IT Implementation Notes</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:leafmouse.github.io/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Samba4 Alpha13 實作筆記</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-04T07:28:00+08:00" pubdate data-updated="true">May 4<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>系統環境:<br/>
CentOS 5.5</p>

<p>所需套件:<br/>
Samba： 4 alpha13</p>

<h3>一、 Download Samba 4</h3>

<p>以下二種做法請擇一使用</p>

<pre><code>rsync -avz samba.org::ftp/unpacked/samba_4_0_test/ samba4
git clone git://git.samba.org/samba.git samba4; cd samba4 &amp;&amp; git checkout -b v4-0-test origin/v4-0-test; cd ..
</code></pre>

<h3>二、 安裝相關套件</h3>

<pre><code>yum install libacl-devel libblkid-devel gnutls-devel readline-devel python-devel bind autoconf gdb rsyslog-gssapi cyrus-sasl-gssapi
</code></pre>

<h3>三、 Compile Samba4</h3>

<pre><code>cd samba4/source4
./autogen-waf.sh
./configure.developer
make
</code></pre>

<h3>四、 Install Samba4</h3>

<pre><code>make install
</code></pre>

<h3>五、 Provision Samba4</h3>

<p>執行 Provision</p>

<pre><code>./setup/provision --realm=myDomain.local --domain=myDomain --adminpass=yourPassword --server-role='domain controller'
</code></pre>

<p>會出現以下訊息</p>

<pre><code>Setting up secrets.ldb
Setting up the registry
Setting up the privileges database
Setting up idmap db
Setting up SAM db
Setting up sam.ldb partitions and settings
Setting up sam.ldb rootDSE
Pre-loading the Samba 4 and AD schema
Adding DomainDN: DC=igs,DC=local
Adding configuration container
Setting up sam.ldb schema
Reopening sam.ldb with new schema
Setting up sam.ldb configuration data
Setting up display specifiers
Adding users container
Modifying users container
Adding computers container
Modifying computers container
Setting up sam.ldb data
Setting up sam.ldb users and groups
Setting up self join
Setting up sam.ldb rootDSE marking as synchronized
rndc: connect failed: 127.0.0.1#953: connection refused
rndc: connect failed: 127.0.0.1#953: connection refused
See /usr/local/samba/private/named.conf for an example  configuration include file for BIND
and /usr/local/samba/private/named.txt for further documentation    required for secure DNS updates
A Kerberos configuration suitable for Samba 4 has been generated    at /usr/local/samba/private/krb5.conf
Please install the phpLDAPadmin configuration located at /usr/  local/samba/private/phpldapadmin-config.php into /etc/phpldapadmin/ config.php
Once the above files are installed, your Samba4 server will be  ready to use
Server Role:        domain controller
Hostname:           dc
NetBIOS Domain:     myDomain
DNS Domain:         myDomain.local
DOMAIN SID:         S-1-5-21-2696521599-3429856061-2704879584
Admin password:     yourPassword
</code></pre>

<h3>六、 Create a share in smb.conf</h3>

<p>編輯設定檔</p>

<pre><code>vi /usr/local/samba/etc/smb.conf
</code></pre>

<p>檔案內容</p>

<pre><code>[share] path = /data/share
read only = no
</code></pre>

<p>建立分享目錄</p>

<pre><code>mkdir -p /data/share
</code></pre>

<h3>七、 starting samba4</h3>

<pre><code>/usr/local/samba/sbin/samba -i -M single
</code></pre>

<h3>八、 Testing Samba4</h3>

<h5>確認samba client版本</h5>

<pre><code>/usr/local/samba/bin/smbclient --version
</code></pre>

<p>版本如下</p>

<pre><code>Version 4.0.0alpha13
</code></pre>

<h5>列出伺服器可用的分享清單</h5>

<p>指令</p>

<pre><code>/usr/local/samba/bin/smbclient -L localhost -U%
</code></pre>

<p>分享清單</p>

<pre><code>Sharename       Type       Comment
---------       ----       -------
netlogon        Disk
sysvol          Disk
IPC$            IPC        IPC Service (Samba 4.0.0alpha13)
ADMIN$          Disk       DISK Service (Samba 4.0.0alpha13)
</code></pre>

<p>測試netlogon</p>

<pre><code>/usr/local/samba/bin/smbclient //localhost/netlogon -Uadministrator%yourPassword
</code></pre>

<p>您應該會得到 &#8220;smb>&#8221; 提示字元, 可存取 netlogon 目錄</p>

<pre><code>smb: \&gt;
</code></pre>

<h5>確認DNS解析否正常</h5>

<p>指令</p>

<pre><code>host -t SRV _ldap._tcp.igs.local.
</code></pre>

<p>結果</p>

<pre><code>_ldap._tcp.igs.local has SRV record 0 100 389 dc.igs.local.
</code></pre>

<p>指令</p>

<pre><code>host -t SRV _kerberos._udp.igs.local.
</code></pre>

<p>結果</p>

<pre><code>_kerberos._udp.igs.local has SRV record 0 100 88 dc.igs.local.
</code></pre>

<p>指令</p>

<pre><code>host -t A dc.igs.local.
</code></pre>

<p>結果</p>

<pre><code>dc.igs.local has address 192.168.0.5
</code></pre>

<h3>九、 Testing kerberos</h3>

<p>若 DNS 解析否正常,您可以測試 kerberos伺服器</p>

<pre><code>kinit administrator@IGS.LOCAL
</code></pre>

<p>Warning: Your password will expire in 41 days on Tue Jan 4 03:21:58 2011</p>

<p>可列出快取中的 Kerberos tickets</p>

<pre><code>klist -e
</code></pre>

<p>結果</p>

<pre><code>Ticket cache: FILE:/tmp/krb5cc_0  
Default principal: administrator@IGS.LOCAL

Valid starting     Expires            Service principal  
11/23/10 04:18:19  11/24/10 04:18:17  krbtgt/IGS.LOCAL@IGS.LOCAL  
Etype (skey, tkt): ArcFour with HMAC/md5, ArcFour with HMAC/md5

Kerberos 4 ticket cache: /tmp/tkt0  
klist: You have no tickets cached
</code></pre>

<h3>十、 Configure kerberos DNS dynamic updates</h3>

<p>另外，你需要為 bind9 設置二個環境變數 (可加在 /etc/rc.d/rc.local)</p>

<pre><code>KEYTAB_FILE="/usr/local/samba/private/dns.keytab"
KRB5_KTNAME="/usr/local/samba/private/dns.keytab"
export KEYTAB_FILE
export KRB5_KTNAM
</code></pre>

<p>這些應該放在你的bind9設定檔。在RedHat平台在 /etc/sysconfig/named。<br/>
嚴格來說，你僅需KEYTAB_FILE或KRB5_KTNAME，但視你的Linux套件而定。</p>

<p>編輯 named</p>

<pre><code>vi /etc/sysconfig/named
</code></pre>

<p>內容</p>

<pre><code>KEYTAB_FILE="/usr/local/samba/private/dns.keytab"
</code></pre>

<p>編輯 named.conf 設定檔</p>

<pre><code>vi /usr/local/bind/etc/named.conf
</code></pre>

<p>option 區段加入以下二行</p>

<pre><code>tkey-gssapi-credential "DNS/igs.local";
tkey-domain "IGS.LOCAL";
</code></pre>

<h3>十一、 Windows XP使用UNC路徑連入</h3>

<p><img src="http://blog.imomo.tw/images/samba4/samba4-unc.jpg" alt="UNC路徑" /></p>

<h3>十二、 用LDAP Admin連入</h3>

<p><img src="http://blog.imomo.tw/images/samba4/ldapadmin.jpg" alt="LDAP Admin" /></p>

<h3>十三、 確認DNS查詢是否正常</h3>

<p><img src="http://blog.imomo.tw/images/samba4/nslookup.jpg" alt="nslookup" /></p>

<h3>十四、 加入網域</h3>

<p><img src="http://blog.imomo.tw/images/samba4/join.jpg" alt="Join domain" /></p>

<h3>十五、 確認加入網域後重新開機</h3>

<p><img src="http://blog.imomo.tw/images/samba4/welcome_join.jpg" alt="Welcome Join domain" /></p>

<h3>十六、 登入網域</h3>

<p><img src="http://blog.imomo.tw/images/samba4/login.jpg" alt="Login domain" /></p>

<h3>十七、 檢查系統內容確認已加入網域</h3>

<p><img src="http://blog.imomo.tw/images/samba4/system.jpg" alt="System" /></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jim Chen</span></span>

      








  


<time datetime="2013-05-04T07:28:00+08:00" pubdate data-updated="true">May 4<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/linux/'>Linux</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://leafmouse.github.io/blog/blog/2013/05/04/samba4alpha13/" data-via="" data-counturl="http://leafmouse.github.io/blog/blog/2013/05/04/samba4alpha13/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/05/04/tesseract-ocr/" title="Previous Post: Tesseract-OCR 安裝筆記">&laquo; Tesseract-OCR 安裝筆記</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/04/samba4alpha13/">Samba4 alpha13 實作筆記</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/04/tesseract-ocr/">Tesseract-OCR 安裝筆記</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/vsftpd-virtual-user-shi-zuo-bi-ji/">vsftpd virtual user 實作筆記</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/18/hello-world/">Apache Reverse Proxy 實作筆記</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/17/fa-biao-octopresswen-zhang-de-liu-cheng/">發表Octopress文章的流程</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jim Chen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
